#!/bin/bash

if [ ! -d ./65k_full/ ];
then
        mkdir -m777 65k_full
fi

archivo=$(echo $1)

for i in $(ls $archivo | grep "65k.nmap"| grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+')
do

tcp=$(grep 'open' $archivo/$i.65k.nmap | awk -F'/' '{print $1}' | tr '\n' ',' | sed 's/,$//')

echo $i $tcp
nmap  -vv -Pn -sV -O -p $tcp --host-timeout 15m  --script "not *flood* and not url-snarf* and not *fuzz* and not *slowloris* and not *dhcp* and not *broadcast* and not *multicast* and not *ipv6* " --script-args=unsafe=1 --script-args=mssql.instance-all --script-args=ms-sql-xp-cmdshell.cmd="ipconfig" -oA ./65k_full/$i.v5  $i  |tee ./65k_full/$i.debug

done